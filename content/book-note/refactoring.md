---
title: "《重构：改善既有代码的设计》读书笔记"
layout: page
date: 2020-03-08
---

[TOC]

# 关于
《重构：改善既有代码的设计》马丁-福勒

# 第1章 重构，一个示例
- 如果你要给程序添加一个特性，但发现代码因缺乏良好的结构而不易于进行更改，那就先重构那个程序，使其比较容易添加该特性，然后再添加该特性。
- 重构前，先检查自己是否有一套可靠的测试集，这些测试必须有自我检验能力。
- 小步修改，每次修改后就运行测试；测试成功后马上提交
- 提炼函数，可以自动化完成的重构
- 傻瓜都能写出计算机可以理解的代码，唯有能写出人类容易理解的代码的，才是优秀的程序员
- 编程时，需要遵循营地法则：保证你离开时的代码库一定比来时更健康
- 以多态取代条件表达式
- 要点
    1. 小步快跑
    2. 手法：提炼函数，内联变量，搬移函数，以多态取代条件表达式

# 第2章 重构的原则
- 如果有人说他们的代码在重构过程中有一两天时间不可用，基本上可以确定，他们在做的事不是重构
- 两顶帽子：添加新功能；重构
- 如果没有重构，程序的内部设计会逐渐腐败变质。当人们只为短期目的而修改代码时，他们经常没有完全理解架构的整体设计，于是代码逐渐失去了自己的结构。程序员越来越难通过阅读源码来理解原来的设计。代码结构的流失有累积效应。
- 改进设计的一个重要方向就是消除重复代码
- 代码量减少并不会是系统运行更快，但是可以将未来可能的程序修改动作变得容易得多。代码越多，做正确的修改就越困难，因为有更多代码需要理解。
- 我在这里做了点修改，系统却不如预期那样工作，因为我没有修改另一处——哪里的代码做着几乎完全一样的事情。
- 重构提高编程速度：好的设计可以持续的高效增加累积功能。但是坏的设计，只在初期比较快，后面就越来越困难了

## 何时重构
- 三次法则：第一次尽管放手做；第二次就会产生反感；第三次在做类似的事情，就应该重构
- 预备性重构：让添加新功能更容易
    - 没有重复代码，修改只需要一次搞定
- 帮助理解的重构：让代码更易懂
    - 命名
- 何时不应该重构
    - 当一堆丑陋的代码能够隐藏在一个API下，就可以不用管。只有当需要理解其中原理时，对其重构才有价值
    - 重写比重构还容易，就别重构了
- 挑战
    - 延缓新功能开发
    - 代码所有权
        - 将函数改名，保留原来的申明，但是可以把旧接口标记为「不推荐使用」deprecated
    - 分支
        - 分支开发越久，合并就越困难
        - 持续集成（CI），基于主干分支开发。每个团队成员每天至少向主线集成一次。代价是必须保证主干分支的健康状态。特性开关
    - 测试：快速发现错误；完整的测试套件
    - 遗留代码：大多数人觉得，有一大笔遗产是件好事，但是从程序员的角度来看就不同了。
    - 数据库重构
- 自动化重构
    - IDEA



# 第3章 代码的坏味道
- 神秘命名：函数取名，最难得两件事情之一
- 重复代码：->提炼函数
- 过长函数：尽量用小函数，而不要用常函数。个人理解：实际上写函数也可以遵循金字塔原理：最上层函数只串联多个子逻辑，子逻辑再递归，一直到可以接受的函数长度，或者单一功能。
    - 原则：每当需要通过注释还说明什么的时候，就需要将这些代码写到一个独立函数中，并取一个好名字
- 过长参数列表
- 全局数据
- 可变数据：减少setXX方法。在很多地方对一个变量赋值，是一件难以追踪的事情
- 发散式变化：如果新加一个简单的改动，必须修改3个函数！！将这些变化的地方，搬移到同一个上线文（比如，同一个类中）
- 散弹式修改：没遇到某种变化，需要在许多不同的类内做许多小修改
- 依恋情节：一个模块内的函数跟其他模块交互比模块内其他函数还多
- 数据泥团：在许多地方看到相同的三四项数据，两个类中相同的字段，许多函数签名中相同的参数。提炼类
- 基本类型偏执：大量使用基本数据类型，如double，string
- 重复的switch：如果有两个以上的相同的switch or if...else... 代码块，应该用多态来取代！！
- 循环语句：以管道取代循环，函数式编程，map filter
- 冗赘的元素：只有一行代码的函数，只有一个函数的类
- 夸夸其谈通用性:如果你的某个抽象类实际没有太多用途，请运用折叠继承体系
- 临时字段：字段仅为某种特殊情况设定。在字段未被使用的时候猜测他的用途太痛苦了！
- 过长的消息链：A->B->C->D：隐藏委托关系
- 中间人：某个类一半的函数委托给其他类
- 内幕交易
- 过大的类
- 异曲同工的类：提炼超类
- 纯数据类型：移除public字段，找到设值点，尝试搬移函数，或提炼函数
- 被拒绝的遗赠：子类只想继承父类一部分东西
- 注释




# 第4章 构筑测试体系

- 每当你收到bug报告，请先写一个单元测试来暴露这个BUG

# 第5章 介绍重构名录
- 略

# 第6章 第一组重构
- 提炼函数：如果你需要花时间浏览一段代码才能弄清他到底在干什么，那么就应该将其提炼到一个函数中，并根据它所做的事情为他命名
- 内联函数：提炼函数反向操作，删除无用的间接层
- 提炼变量：取代表达式，提高可读性
- 内链变量
- 函数改名
- 封装变量：封装一组数据
- 变量改名
- 引入参数对象：将一组数据用一个类来实现
- 函数组合成类
- 拆分阶段：一段代码有两个部分，每部分单独干一件事情，则可以拆分成两个函数，顺序执行


- 注解：一组相同的字段可以构建一个数据结构，一组总是对同一个数据结构的函数，可以构成一个类

# 第7章 封装


# 第8章 搬移特性


# 第9章 重新组织数据


# 第10章 简化条件逻辑


# 第11章 重构API


# 第12章 处理继承关系

# FAQ
## 如果待重构的代码没有测试怎么办
- 添加测试用例

## CI怎么保证master分支的健康
