<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/normalize.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
        <title>使用命令行构建智能合约 - Tracholar的个人wiki</title>
        <meta name="keywords" content="technology, machine learning, data mining, economics, accounting"/>
        <meta name="description" content="A wiki website of tracholar when I learned new knowledgy and technics."/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width" />

        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {inlineMath: [['$(',')$'], ['\\(','\\)'], ['$', '$']]}
        });
        </script>
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>

        <!-- Google Adsense -->
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-78529611-1', 'auto');
          ga('send', 'pageview');


            // Google Adsense Auto AD
            (adsbygoogle = window.adsbygoogle || []).push({});
            /*
             (adsbygoogle = window.adsbygoogle || []).push({
                  google_ad_client: "ca-pub-6300557868920774",
                  enable_page_level_ads: true
             });
             */
        </script>
    </head>

    <body>
        <div id="container">
            <div id="google-search" style="width:200px; float:right; margin: 20px 0;">
                <form action="//cse.google.com/cse" method="get" id="search-form">
                    <input type="hidden" name="cx" value="015970462532790426975:gqlen38ywus"/>
                    <input type="text" name="q"  style="line-height:20px; padding:4px;" placeholder="站内搜索"/>
                    <svg width="13" height="13" viewBox="0 0 13 13" style="position:relative; left: -20px;" onclick="document.getElementById('search-form').submit()">
                        <title>搜索</title>
                        <path d="m4.8495 7.8226c0.82666 0 1.5262-0.29146 2.0985-0.87438 0.57232-0.58292 0.86378-1.2877 0.87438-2.1144 0.010599-0.82666-0.28086-1.5262-0.87438-2.0985-0.59352-0.57232-1.293-0.86378-2.0985-0.87438-0.8055-0.010599-1.5103 0.28086-2.1144 0.87438-0.60414 0.59352-0.8956 1.293-0.87438 2.0985 0.021197 0.8055 0.31266 1.5103 0.87438 2.1144 0.56172 0.60414 1.2665 0.8956 2.1144 0.87438zm4.4695 0.2115 3.681 3.6819-1.259 1.284-3.6817-3.7 0.0019784-0.69479-0.090043-0.098846c-0.87973 0.76087-1.92 1.1413-3.1207 1.1413-1.3553 0-2.5025-0.46363-3.4417-1.3909s-1.4088-2.0686-1.4088-3.4239c0-1.3553 0.4696-2.4966 1.4088-3.4239 0.9392-0.92727 2.0864-1.3969 3.4417-1.4088 1.3553-0.011889 2.4906 0.45771 3.406 1.4088 0.9154 0.95107 1.379 2.0924 1.3909 3.4239 0 1.2126-0.38043 2.2588-1.1413 3.1385l0.098834 0.090049z">
                        </path>
                    </svg>
                </form>

            </div>
            
<div id="header">
  <div id="post-nav"><a href="/wiki/">Home</a>&nbsp;»&nbsp;<a href="/wiki/#blockchain">blockchain</a>&nbsp;»&nbsp;使用命令行构建智能合约</div>
</div>
<div class="clearfix"></div>
<div id="title">使用命令行构建智能合约</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">使用命令行构建智能合约</a><ul>
<li><a href="#greeter">你的第一个公民：Greeter</a></li>
<li><a href="#solc">Solc编译器</a><ul>
<li><a href="#_2">编译你的合同</a></li>
<li><a href="#_3">使用在线编译器</a></li>
</ul>
</li>
<li><a href="#greeter_1">运行Greeter</a><ul>
<li><a href="#_4">让其他人与您的代码进行交互</a></li>
<li><a href="#_5">清理后自己：</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h2 id="_1">使用命令行构建智能合约</h2>
<p>这个页面将帮助你在以太坊命令行建立一个Hello，World合约。如果您不知道如何使用命令行，我们建议您跳过本教程，而是使用图形用户界面构建自定义标记。</p>
<p>智能合约是以太坊区块链上的账户持有对象。它们包含代码功能，可以与其他合同进行交互，做出决定，存储数据，并将ether发送给其他人。契约是由他们的创造者定义的，但他们的执行，以及他们所提供的服务，都是由以太网本身提供的。只要整个网络存在，它们就会存在并且可执行，只有被编程为自毁，它们才会消失。</p>
<p>你可以用合同做什么？事实上，你几乎可以做任何事情，但是对于我们的入门指南，我们来做一些简单的事情：首先你将创建一个经典的“Hello<br />
World”合约，然后你可以建立你自己的密码令牌发送给任何你喜欢的人。一旦你掌握了这一点，那么你将通过众筹筹集资金，如果成功，将提供一个完全透明和民主的组织，只会服从自己的公民，永远不会摆脱它的宪法，不能被检查或关闭。而所有这些都在不到300行的代码中。</p>
<p>在你开始之前：</p>
<ul>
<li><a href="getch-eth.html">安装以太坊CLI</a></li>
<li><a href="https://github.com/ethereum/go-ethereum/wiki/Contracts-and-Transactions">详细了解合同</a></li>
</ul>
<p>进入<code>geth</code>控制台之前，请确认GUI已关闭。 运行<code>geth</code>开始同步过程（第一次运行可能需要一段时间）。</p>
<p>那么现在就开始吧。</p>
<h3 id="greeter">你的第一个公民：Greeter</h3>
<p>现在你已经掌握了以太坊的基本知识，让我们进入你的第一个严肃的合同。Frontier是一个很大的开放领域，有时你可能会感到孤独，所以我们的第一步就是创造一个自动的伴侣，当你感到孤独的时候迎接你。我们会称他为“Greeter”。</p>
<p>Greeter是一个智能的数字实体，它存在于区块链中，并能够根据其输入与任何与之交互的人进行交谈。它可能不是一个演讲者，但它是一个很好的倾听者。这是它的代码：</p>
<div class="hlcode"><pre><span></span>    <span class="nx">contract</span> <span class="nx">mortal</span> <span class="p">{</span>
        <span class="cm">/* Define variable owner of the type address */</span>
        <span class="nx">address</span> <span class="nx">owner</span><span class="p">;</span>

        <span class="cm">/* This function is executed at initialization and sets the owner of the contract */</span>
        <span class="kd">function</span> <span class="nx">mortal</span><span class="p">()</span> <span class="p">{</span> <span class="nx">owner</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span><span class="p">;</span> <span class="p">}</span>

        <span class="cm">/* Function to recover the funds on the contract */</span>
        <span class="kd">function</span> <span class="nx">kill</span><span class="p">()</span> <span class="p">{</span> <span class="k">if</span> <span class="p">(</span><span class="nx">msg</span><span class="p">.</span><span class="nx">sender</span> <span class="o">==</span> <span class="nx">owner</span><span class="p">)</span> <span class="nx">selfdestruct</span><span class="p">(</span><span class="nx">owner</span><span class="p">);</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">contract</span> <span class="nx">greeter</span> <span class="nx">is</span> <span class="nx">mortal</span> <span class="p">{</span>
        <span class="cm">/* Define variable greeting of the type string */</span>
        <span class="nx">string</span> <span class="nx">greeting</span><span class="p">;</span>

        <span class="cm">/* This runs when the contract is executed */</span>
        <span class="kd">function</span> <span class="nx">greeter</span><span class="p">(</span><span class="nx">string</span> <span class="nx">_greeting</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
            <span class="nx">greeting</span> <span class="o">=</span> <span class="nx">_greeting</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="cm">/* Main function */</span>
        <span class="kd">function</span> <span class="nx">greet</span><span class="p">()</span> <span class="nx">constant</span> <span class="nx">returns</span> <span class="p">(</span><span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">greeting</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
</pre></div>


<p>你会注意到这个代码中有两个不同的合约：“mortal”和“greeter”。这是因为Solidity（我们使用的高级合同语言）具有继承性，这意味着一个契约可以继承另一个契约的特征。这对于简化编码非常有用，因为合同的常见特征不需要每次重写，所有合同都可以用更小，更易读的块来编写。所以只要声明迎宾者是凡人，你就继承了“凡人”契约的所有特征，并使迎宾者的代码简单易读。</p>
<p>继承特征“凡人”仅仅意味着迎宾合同可以被其所有者杀死，清理区块链，并在不再需要合同时收回锁定的资金。以太坊的契约默认为不死的，没有所有者，这意味着一旦被部署，作者就没有特殊的特权了。在部署之前考虑这一点。</p>
<h3 id="solc">Solc编译器</h3>
<p>在你能够部署它之前，你需要两件事情：编译代码和应用程序二进制接口，它是一个JavaScript对象，它定义了如何与合约进行交互。</p>
<p>这两个事情你都可以通过使用编译器完成。你可以使用solidity编译器。</p>
<p>如果你还没有安装编译器，那么你需要安装一个。你可以在这里找到<a href="http://solidity.readthedocs.io/en/develop/installing-solidity.html">安装Solidity的说明</a>。</p>
<blockquote>
<p><strong>译者注</strong><br />
solc编译器安装方法：直接利用npm包管理器安装<br />
<code>npm install -g solc</code></p>
</blockquote>
<h4 id="_2">编译你的合同</h4>
<p>如果你没有得到以上的固体，那么你需要安装它。你可以在这里找到安装Solidity的说明。</p>
<p>现在你已经安装了编译器，你需要编译合约来获取编译后的代码和应用程序二进制接口。</p>
<div class="hlcode"><pre><span></span>solc -o target --bin --abi Greeter.sol
</pre></div>


<p>这将创建两个文件，一个文件包含已编译的代码，另一个文件在名为target的目录中创建应用程序二进制接口。</p>
<div class="hlcode"><pre><span></span>$tree
.
├── Greeter.sol
└── target
   ├── Greeter.abi
   ├── Greeter.bin
   ├── Mortal.abi
   └── Mortal.bin
</pre></div>


<p>你会看到有为两个合同创建的文件;但是因为Greeter包括Mortal，所以你不需要部署Mortal来部署Greeter。</p>
<p>您可以使用这两个文件来创建和部署合同。</p>
<div class="hlcode"><pre><span></span>var greeterFactory = eth.contract(&amp;lt;contents of the file Greeter.abi&amp;gt;)

var greeterCompiled = &quot;0x&quot; + &quot;&amp;lt;contents of the file Greeter.bin&quot;
</pre></div>


<p>你现在已经编译了你的代码，并把它提供给Geth。现在您需要准备好进行部署，包括设置一些变量，例如您希望使用的问候语。将下面的第一行编辑为比“Hello<br />
World！”更有趣的内容并执行这些命令：</p>
<div class="hlcode"><pre><span></span>    <span class="kd">var</span> <span class="nx">_greeting</span> <span class="o">=</span> <span class="s2">&quot;Hello World!&quot;</span>

    <span class="kd">var</span> <span class="nx">greeter</span> <span class="o">=</span> <span class="nx">greeterFactory</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="nx">_greeting</span><span class="p">,{</span><span class="nx">from</span><span class="o">:</span><span class="nx">eth</span><span class="p">.</span><span class="nx">accounts</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nx">data</span><span class="o">:</span><span class="nx">greeterCompiled</span><span class="p">,</span><span class="nx">gas</span><span class="o">:</span><span class="mi">47000000</span><span class="p">},</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">contract</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>

          <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Contract transaction send: TransactionHash: &quot;</span> <span class="o">+</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">transactionHash</span> <span class="o">+</span> <span class="s2">&quot; waiting to be mined...&quot;</span><span class="p">);</span>

          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Contract mined! Address: &quot;</span> <span class="o">+</span> <span class="nx">contract</span><span class="p">.</span><span class="nx">address</span><span class="p">);</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">contract</span><span class="p">);</span>
          <span class="p">}</span>

        <span class="p">}</span>
    <span class="p">})</span>
</pre></div>


<h4 id="_3">使用在线编译器</h4>
<p>如果你没有安装solC，你可以简单地使用在线编译器。将上面的源代码复制到在线solidity编译器，然后您的编译代码应该出现在左侧窗格中。将<code>greeter</code>合同和<code>mortal</code>合同中标有Web3<br />
deploy的框中的代码复制到单个文本文件中。现在，在该文件中，将第一行更改为您的问候语：</p>
<div class="hlcode"><pre><span></span>    <span class="kd">var</span> <span class="nx">_greeting</span> <span class="o">=</span> <span class="s2">&quot;Hello World!&quot;</span>
</pre></div>


<p>现在您可以将结果文本粘贴到您的geth窗口中，或者使用<code>loadScript("yourFilename.js")</code>导入文件。等待30秒，你会看到这样的消息：</p>
<div class="hlcode"><pre><span></span>Contract mined! address: 0xdaa24d02bad7e9d6a80106db164bad9399a0423e
</pre></div>


<p>您可能必须使用您在开始时选择的密码来“解锁”发送交易的帐户，因为您需要支付部署合同的天然气费用。<br />
<code>personal.unlockAccount(web3.eth.accounts[0], "yourPassword")</code>。</p>
<p>该合同估计需要约18万个气体部署（根据在线固体编译器），在撰写本文时，测试网上的气体价格为20 gwei（等于（20000000000<br />
wei，或0.00000002 ether）每单位有很多有用的统计数据，包括网络统计页面的最新天然气价格。</p>
<p>请注意，这些费用并不支付给以太坊开发者，而是交给了矿工们，那些计算机正在努力寻找新的区块并保证网络安全的同行。天然气价格是由当前的计算供求市场决定的。如果天然气价格太高，你可以成为一名矿工，降低你的要价。</p>
<p>在不到一分钟的时间内，你应该有一个合同地址的日志，这意味着你已经成功地部署了你的合同。您可以使用以下命令验证部署的代码（将被编译）：</p>
<div class="hlcode"><pre><span></span>eth.getCode(greeter.address)
</pre></div>


<p>如果它返回“0x”以外的任何内容，那么恭喜！你的小家伙活着！如果再次创建合同（通过执行另一个eth.sendTransaction），它将被发布到一个新的地址。</p>
<h3 id="greeter_1">运行Greeter</h3>
<p>为了打电话给你的机器人，只需在你的终端上输入以下命令：</p>
<div class="hlcode"><pre><span></span>greeter.greet();
</pre></div>


<p>由于这个调用在区块链上没有任何变化，所以它立即返回并且没有任何天然气成本。你应该看到它返回你的问候语：</p>
<div class="hlcode"><pre><span></span>&#39;Hello World!&#39;
</pre></div>


<h4 id="_4">让其他人与您的代码进行交互</h4>
<p>为了让其他人运行你的合同，他们需要两件事情：合同所在的地址和ABI（应用程序二进制接口），这是一种用户手册，描述了它的功能名称以及如何给你的JavaScript控制台。为了让他们每个人都运行这些命令：</p>
<div class="hlcode"><pre><span></span>greeterCompiled.greeter.info.abiDefinition;
greeter.address;
</pre></div>


<p>如果使用基于浏览器的工具进行编译，则可以从标有“接口”的<code>greeter</code>和<code>mortal</code>合同的字段中获取ABI。</p>
<p>然后，您可以实例化一个JavaScript对象，该对象可用于在连接到网络的任何计算机上调用合约。替换'ABI'（一个数组）和'Address'（一个字符串）在JavaScript中创建一个契约对象：</p>
<div class="hlcode"><pre><span></span>var greeter = eth.contract(ABI).at(Address);
</pre></div>


<p>这个特殊的例子可以通过简单的调用来实例化：</p>
<div class="hlcode"><pre><span></span>    <span class="kd">var</span> <span class="nx">greeter2</span> <span class="o">=</span> <span class="nx">eth</span><span class="p">.</span><span class="nx">contract</span><span class="p">([{</span><span class="nx">constant</span><span class="o">:</span><span class="kc">false</span><span class="p">,</span><span class="nx">inputs</span><span class="o">:</span><span class="p">[],</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;kill&#39;</span><span class="p">,</span><span class="nx">outputs</span><span class="o">:</span><span class="p">[],</span><span class="nx">type</span><span class="o">:</span><span class="s1">&#39;function&#39;</span><span class="p">},{</span><span class="nx">constant</span><span class="o">:</span><span class="kc">true</span><span class="p">,</span><span class="nx">inputs</span><span class="o">:</span><span class="p">[],</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;greet&#39;</span><span class="p">,</span><span class="nx">outputs</span><span class="o">:</span><span class="p">[{</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span><span class="s1">&#39;string&#39;</span><span class="p">}],</span><span class="nx">type</span><span class="o">:</span><span class="s1">&#39;function&#39;</span><span class="p">},{</span><span class="nx">inputs</span><span class="o">:</span><span class="p">[{</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;_greeting&#39;</span><span class="p">,</span><span class="nx">type</span><span class="o">:</span><span class="s1">&#39;string&#39;</span><span class="p">}],</span><span class="nx">type</span><span class="o">:</span><span class="s1">&#39;constructor&#39;</span><span class="p">}]).</span><span class="nx">at</span><span class="p">(</span><span class="s1">&#39;greeterAddress&#39;</span><span class="p">);</span>
</pre></div>


<p>将greeterAddress替换为合同的地址。</p>
<p>提示：如果你的机器上没有正确的安装编译器，你可以从在线编译器获取ABI。为此，请使用下面的代码，仔细地用编译器中的abi替换greeterCompiled.greeter.info.abiDefinition。</p>
<h4 id="_5">清理后自己：</h4>
<p>你必须非常高兴才能签下第一份合同，但是当业主继续写下更多的合同时，这种激动有时会消失，导致在区块链上看到放弃的合同。未来，区块链租金可能会实施，以增加区块链的可扩展性，但现在，成为一个好公民，并人道地放弃你的废弃机器人。</p>
<p>交易将需要发送到网络，并在下面的代码运行后支付块链更改的费用。自毁是由网络补贴的，所以它的成本要比平常的交易少得多。</p>
<div class="hlcode"><pre><span></span>greeter.kill.sendTransaction({from:eth.accounts[0]})
</pre></div>


<p>这只能由合同所有者发送的交易触发。您可以验证该行为是否完成，只要看看是否返回0：</p>
<div class="hlcode"><pre><span></span>eth.getCode(greeter.address)
</pre></div>


<p>请注意，每个合约都必须执行自己的kill子句。在这种特殊情况下，只有创建合同的帐户才能杀死它。</p>
<p>如果你不添加任何杀人条款，它可能永远独立于你和任何地球上的边界永远活着，所以在你实际使用之前，请检查你的当地法律对此的看法，包括对技术出口的任何可能的限制，任何有关数字众生公民权利的立法。对待你的机器人人道。</p>
</div>
<div id="income">
    <!--img src="/wiki/static/images/support-qrcode.png" alt="支持我" style="max-width:300px;" /-->

    <ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-6300557868920774"
     data-ad-slot="6882414849"></ins>
</div>
<div id="content-footer">created in <span class="create-date date"> 2018-01-23 </span></div>

<div id="comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script type="text/javascript">
const gitment = new Gitment({
  id: location.pathname,
  title: '使用命令行构建智能合约',
  owner: 'tracholar',
  repo: 'wiki',
  oauth: {
    client_id: '0cc0476e504b5e70ae7c',
    client_secret: 'ab98e39ef79469040057eba9c6b2b543b84c72ee',
  },
  // ...
  // For more available options, check out the documentation below
})

gitment.render('comments')
// or
// gitment.render(document.getElementById('comments'))
// or
// document.body.appendChild(gitment.render())
</script>

        </div>
        <div id="footer">
            <span>
                Copyright © 2019 tracholar.
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
            </span>
        </div>
        

        <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?df74779713027375e7b79302fb72d7b0";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>


        <script src="/wiki/tipuesearch_content.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch_set.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch.min.js"></script>
    </body>
</html>