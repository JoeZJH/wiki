<!DOCTYPE HTML>
<html>
    <head>
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/style.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/css/tango.css">
        <link rel="Stylesheet" type="text/css" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/normalize.css">
        <link rel="stylesheet" href="/wiki/static/plugin/tipuesearch/css/tipuesearch.css">
        <link rel="shortcut icon" href="/wiki/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/wiki/favicon.ico" type="image/x-icon">
        <title>Python 多线程和多进程编程总结 - tracholar's personal knowledge wiki</title>
        <meta name="keywords" content="technology, machine learning, data mining, economics, accounting"/>
        <meta name="description" content="A wiki website of tracholar when I learned new knowledgy and technics."/>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <meta name="viewport" content="width=device-width" />

        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {inlineMath: [['$(',')$'], ['\\(','\\)']]}
        });
        </script>
        <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="https://code.jquery.com/jquery-2.2.4.min.js"
            integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
            crossorigin="anonymous"></script>

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-78529611-1', 'auto');
          ga('send', 'pageview');

        </script>
    </head>

    <body>
        <div id="container">
            
<div id="header">
  <div id="post-nav"><a href="/wiki/">Home</a>&nbsp;»&nbsp;<a href="/wiki/#python">python</a>&nbsp;»&nbsp;Python 多线程和多进程编程总结</div>
</div>
<div class="clearfix"></div>
<div id="title">Python 多线程和多进程编程总结</div>
<div id="content">
  <div class="toc"><span class="toctitle">Table of Contents</span><ul>
<li><a href="#_1">简介</a></li>
<li><a href="#_2">线程与进程</a></li>
<li><a href="#_3">多线程编程</a><ul>
<li><a href="#_4">线程的状态</a></li>
<li><a href="#_5">线程的类型</a></li>
<li><a href="#pythongil">python的GIL</a></li>
<li><a href="#_6">创建线程</a></li>
<li><a href="#join">线程合并（join方法）</a></li>
<li><a href="#_7">线程同步与互斥锁</a></li>
<li><a href="#_8">可重入锁</a></li>
<li><a href="#_9">条件变量</a></li>
<li><a href="#_10">队列</a></li>
<li><a href="#_11">线程通信</a></li>
<li><a href="#_12">后台线程</a></li>
</ul>
</li>
<li><a href="#_13">进程</a><ul>
<li><a href="#process">类Process</a><ul>
<li><a href="#daemon">不加daemon属性</a></li>
<li><a href="#daemon_1">加上daemon属性</a></li>
<li><a href="#daemon_2">设置daemon执行完结束的方法</a></li>
</ul>
</li>
<li><a href="#lock">Lock</a></li>
<li><a href="#semaphore">Semaphore</a></li>
<li><a href="#event">Event</a></li>
<li><a href="#queue">Queue</a><ul>
<li><a href="#pipe">Pipe</a></li>
</ul>
</li>
<li><a href="#pool">Pool</a></li>
</ul>
</li>
<li><a href="#_14">资料来源</a></li>
</ul>
</div>
<h2 id="_1">简介</h2>
<p>早已进入多核时代的计算机，怎能不用多线程和多进程进行加速。<br />
我在使用python的过程中，用到过几次多线程和多进程加速，觉得<br />
充分利用CPU节省时间是一种很有“延长生命”的感觉。现将网络上看到的python的<br />
多线程和多进程编程常用的知识点汇总在这里。</p>
<h2 id="_2">线程与进程</h2>
<p>线程与进程是操作系统里面的术语，简单来讲，每一个应用程序都有一个自己的进程。<br />
操作系统会为这些进程分配一些执行资源，例如内存空间等。<br />
在进程中，又可以创建一些线程，他们共享这些内存空间，并由操作系统调用，<br />
以便并行计算。</p>
<p>32位系统受限于总线宽度，单个进程最多能够访问的地址空间<br />
只有4G，利用<a href="https://en.wikipedia.org/wiki/Physical_Address_Extension">物理地址扩展(PAE)</a><br />
技术，可以让CPU访问超过4G内存。但是在单个进程还是只能访问4G<br />
空间，PAE的优势是可以让不同进程累计使用的内存超过4G。<br />
在个人电脑上，还是建议使用64位系统，便于使用大内存<br />
提升程序的运行性能。</p>
<h2 id="_3">多线程编程</h2>
<h3 id="_4">线程的状态</h3>
<p>创建线程之后，线程并不是始终保持一个状态。其状态大概如下：</p>
<ul>
<li>New 创建。</li>
<li>Runnable 就绪。等待调度</li>
<li>Running 运行。</li>
<li>Blocked 阻塞。阻塞可能在 Wait Locked Sleeping</li>
<li>Dead 消亡</li>
</ul>
<h3 id="_5">线程的类型</h3>
<p>线程有着不同的状态，也有不同的类型。大致可分为：</p>
<ul>
<li>主线程</li>
<li>子线程</li>
<li>守护线程（后台线程）</li>
<li>前台线程</li>
</ul>
<h3 id="pythongil">python的GIL</h3>
<p>GIL即全局解释器锁，它使得python的多线程无法充分利用<br />
多核的优势，但是对于I/O操作频繁的爬虫之类的程序，<br />
利用多线程带来的优势还是很明显的。<br />
如果要利用多核优势，还是用多进程吧。</p>
<h3 id="_6">创建线程</h3>
<p>Python提供两个模块进行多线程的操作，分别是<code>thread</code>和<code>threading</code>，<br />
前者是比较低级的模块，用于更底层的操作，一般应用级别的开发不常用。</p>
<p>第一种方法是创建<code>threading.Thread</code>的子类，重写<code>run</code>方法。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">threading</span>

<span class="k">class</span> <span class="nc">MyThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">print</span> <span class="s1">&#39;thread {}, @number: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">print</span> <span class="s2">&quot;Start main threading&quot;</span>
    <span class="c1"># 创建三个线程</span>
    <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyThread</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
    <span class="c1"># 启动三个线程</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">print</span> <span class="s2">&quot;End Main threading&quot;</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">main</span><span class="p">()</span>
</pre></div>


<p>输入如下：（不同的环境不一样）</p>
<div class="hlcode"><pre><span></span>Start main threading
thread Thread-1, @number: 0
thread Thread-2, @number: 0
thread Thread-3, @number: 0
End Main threading
thread Thread-1, @number: 1
thread Thread-3, @number: 1
thread Thread-2, @number: 1
thread Thread-3, @number: 2
thread Thread-1, @number: 2
 thread Thread-2, @number: 2
thread Thread-2, @number: 3
thread Thread-1, @number: 3
thread Thread-3, @number: 3
</pre></div>


<h3 id="join">线程合并（join方法）</h3>
<p>主线程结束后，子线程还在运行，<code>join</code>方法使得主线程等到子线程结束<br />
时才退出。</p>
<div class="hlcode"><pre><span></span><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">print</span> <span class="s2">&quot;Start main threading&quot;</span>

    <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">MyThread</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="c1"># 一次让新创建的线程执行 join</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
        <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">print</span> <span class="s2">&quot;End Main threading&quot;</span>
</pre></div>


<h3 id="_7">线程同步与互斥锁</h3>
<p>为了避免线程不同步造成是数据不同步，可以对资源进行加锁。<br />
也就是访问资源的线程需要获得锁，才能访问。<br />
<code>threading</code>模块正好提供了一个Lock功能</p>
<div class="hlcode"><pre><span></span><span class="n">mutex</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</pre></div>


<p>在线程中获取锁</p>
<div class="hlcode"><pre><span></span><span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
</pre></div>


<p>使用完后，释放锁</p>
<div class="hlcode"><pre><span></span><span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>


<h3 id="_8">可重入锁</h3>
<p>为了支持在同一线程中多次请求同一资源，<br />
python提供了可重入锁（RLock）。<br />
RLock内部维护着一个<code>Lock</code>和一个<code>counter</code>变量，<br />
<code>counter</code>记录了acquire的次数，从而使得资源可以被多次require。<br />
直到一个线程所有的acquire都被release，其他的线程才能获得资源。</p>
<p>创建RLock</p>
<div class="hlcode"><pre><span></span><span class="n">mutex</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
</pre></div>


<p>线程内多次进入锁和释放锁</p>
<div class="hlcode"><pre><span></span><span class="k">class</span> <span class="nc">MyThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">print</span> <span class="s2">&quot;thread {} get mutex&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
            <span class="n">mutex</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>


<h3 id="_9">条件变量</h3>
<p>实用锁可以达到线程同步，前面的互斥锁就是这种机制。更复杂的环境，需要针对锁进行一些条件判断。Python提供了Condition对象。它除了具有acquire和release方法之外，还提供了wait和notify方法。线程首先acquire一个条件变量锁。如果条件不足，则该线程wait，如果满足就执行线程，甚至可以notify其他线程。其他处于wait状态的线程接到通知后会重新判断条件。</p>
<p>条件变量可以看成不同的线程先后acquire获得锁，如果不满足条件，可以理解为被扔到一个（Lock或RLock）的waiting池。直达其他线程notify之后再重新判断条件。该模式常用于生成消费者模式：</p>
<div class="hlcode"><pre><span></span><span class="n">queue</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">con</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Condition</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Producer</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">con</span><span class="o">.</span><span class="n">acquire</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">elem</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">elem</span><span class="p">)</span>
                    <span class="k">print</span> <span class="s2">&quot;Producer a elem {}, Now size is {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
                <span class="n">con</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Consumer</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">con</span><span class="o">.</span><span class="n">acquire</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">elem</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="k">print</span> <span class="s2">&quot;Consumer a elem {}. Now size is {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">queue</span><span class="p">))</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">())</span>
                    <span class="n">con</span><span class="o">.</span><span class="n">notify</span><span class="p">()</span>
                <span class="n">con</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">Producer</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">Consumer</span><span class="p">()</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<h3 id="_10">队列</h3>
<p>带锁的队列<code>Queue</code>。<br />
创建10个元素的队列</p>
<div class="hlcode"><pre><span></span><span class="n">queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>


<p>队列通过<code>put</code>加入元素，通过<code>get</code>方法获取元素。</p>
<h3 id="_11">线程通信</h3>
<p>线程可以读取共享的内存，通过内存做一些数据处理。<br />
这就是线程通信的一种，python还提供了更加高级的线程通信接口。<br />
Event对象可以用来进行线程通信，调用event对象的wait方法，<br />
线程则会阻塞等待，直到别的线程set之后，才会被唤醒。</p>
<div class="hlcode"><pre><span></span><span class="k">class</span> <span class="nc">MyThread</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyThread</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span> <span class="o">=</span> <span class="n">event</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s2">&quot;thread {} is ready &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">print</span> <span class="s2">&quot;thread {} run&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

<span class="n">signal</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">MyThread</span><span class="p">(</span><span class="n">signal</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;after {}s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</pre></div>


<h3 id="_12">后台线程</h3>
<p>默认情况下，主线程退出之后，即使子线程没有join。那么主线程结束后，<br />
子线程也依然会继续执行。如果希望主线程退出后，<br />
其子线程也退出而不再执行，则需要设置子线程为后台线程。python提供了<code>setDeamon</code>方法。</p>
<h2 id="_13">进程</h2>
<p>python中的多线程其实并不是真正的多线程，如果想要充分地使用多核CPU的资源，在python中大部分情况需要使用多进程。Python提供了非常好用的多进程包multiprocessing，只需要定义一个函数，Python会完成其他所有事情。借助这个包，可以轻松完成从单进程到并发执行的转换。multiprocessing支持子进程、通信和共享数据、执行不同形式的同步，提供了Process、Queue、Pipe、Lock等组件。</p>
<h3 id="process">类Process</h3>
<ul>
<li>
<p>创建进程的类：<code>Process([group [, target [, name [, args [, kwargs]]]]])</code>，<br />
target表示调用对象，args表示调用对象的位置参数元组。<br />
kwargs表示调用对象的字典。name为别名。group实质上不使用。</p>
</li>
<li>
<p>方法：is_alive()、join([timeout])、run()、start()、terminate()。其中，Process以start()启动某个进程。</p>
</li>
<li>
<p>属性：authkey、daemon（要通过start()设置）、exitcode(进程在运行时为None、如果为–N，表示被信号N结束）、name、pid。其中daemon是父进程终止后自动终止，且自己不能产生新进程，必须在start()之前设置。</p>
</li>
</ul>
<p>例：创建函数并将其作为单个进程</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;The time is {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;p.pid:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">pid</span>
    <span class="k">print</span> <span class="s2">&quot;p.name:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span>
    <span class="k">print</span> <span class="s2">&quot;p.is_alive:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()</span>
</pre></div>


<p>结果</p>
<div class="hlcode"><pre><span></span>p.pid: 8736
p.name: Process-1
p.is_alive: True
The time is Tue Apr 21 20:55:12 2015
The time is Tue Apr 21 20:55:15 2015
The time is Tue Apr 21 20:55:18 2015
The time is Tue Apr 21 20:55:21 2015
The time is Tue Apr 21 20:55:24 2015
</pre></div>


<p>例：创建函数并将其作为多个进程</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">worker_1</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="k">print</span> <span class="s2">&quot;worker_1&quot;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;end worker_1&quot;</span>

<span class="k">def</span> <span class="nf">worker_2</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="k">print</span> <span class="s2">&quot;worker_2&quot;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;end worker_2&quot;</span>

<span class="k">def</span> <span class="nf">worker_3</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="k">print</span> <span class="s2">&quot;worker_3&quot;</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;end worker_3&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker_1</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,))</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker_2</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">p3</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker_3</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,))</span>

    <span class="n">p1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p3</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;The number of CPU is:&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">active_children</span><span class="p">():</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;child   p.name:&quot;</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">p.id&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>
    <span class="k">print</span> <span class="s2">&quot;END!!!!!!!!!!!!!!!!!&quot;</span>
</pre></div>


<p>结果</p>
<div class="hlcode"><pre><span></span>The number of CPU is:4
child   p.name:Process-3    p.id7992
child   p.name:Process-2    p.id4204
child   p.name:Process-1    p.id6380
END!!!!!!!!!!!!!!!!!
worker_1
worker_3
worker_2
end worker_1
end worker_2
end worker_3
</pre></div>


<p>例：将进程定义为类</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">ClockProcess</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval</span><span class="p">):</span>
        <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">interval</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s2">&quot;the time is {0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()))</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interval</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">ClockProcess</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>注：进程p调用start()时，自动调用run()</p>
<p>结果</p>
<div class="hlcode"><pre><span></span>the time is Tue Apr 21 20:31:30 2015
the time is Tue Apr 21 20:31:33 2015
the time is Tue Apr 21 20:31:36 2015
the time is Tue Apr 21 20:31:39 2015
the time is Tue Apr 21 20:31:42 2015
</pre></div>


<p>例：daemon程序对比结果</p>
<h4 id="daemon">不加daemon属性</h4>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;work start:{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()));</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;work end:{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()));</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;end!&quot;</span>
</pre></div>


<p>结果</p>
<div class="hlcode"><pre><span></span>end!
work start:Tue Apr 21 21:29:10 2015
work end:Tue Apr 21 21:29:13 2015
</pre></div>


<h4 id="daemon_1">加上daemon属性</h4>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;work start:{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()));</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;work end:{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()));</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;end!&quot;</span>
</pre></div>


<p>结果</p>
<div class="hlcode"><pre><span></span>end!
</pre></div>


<p>注：因子进程设置了daemon属性，主进程结束，它们就随着结束了。</p>
<h4 id="daemon_2">设置daemon执行完结束的方法</h4>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">interval</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;work start:{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()));</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;work end:{0}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">()));</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span>
    <span class="n">p</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;end!&quot;</span>
</pre></div>


<p>结果</p>
<div class="hlcode"><pre><span></span>work start:Tue Apr 21 22:16:32 2015
work end:Tue Apr 21 22:16:35 2015
end!
</pre></div>


<h3 id="lock">Lock</h3>
<p>当多个进程需要访问共享资源的时候，Lock可以用来避免访问的冲突。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">worker_with</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Lockd acquired via with</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">worker_no_with</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
    <span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;a+&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="k">while</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">fs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Lock acquired directly</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">-=</span> <span class="mi">1</span>
        <span class="n">fs</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">lock</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
    <span class="n">f</span> <span class="o">=</span> <span class="s2">&quot;file.txt&quot;</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker_with</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
    <span class="n">nw</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker_no_with</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">lock</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
    <span class="n">w</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">nw</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">print</span> <span class="s2">&quot;end&quot;</span>
</pre></div>


<p>结果（输出文件）</p>
<div class="hlcode"><pre><span></span>Lockd acquired via with
Lockd acquired via with
Lockd acquired via with
Lockd acquired via with
Lockd acquired via with
Lockd acquired via with
Lockd acquired via with
Lockd acquired via with
Lockd acquired via with
Lock acquired directly
Lock acquired directly
Lock acquired directly
Lock acquired directly
Lock acquired directly
Lock acquired directly
Lock acquired directly
Lock acquired directly
Lock acquired directly
</pre></div>


<h3 id="semaphore">Semaphore</h3>
<p>Semaphore用来控制对共享资源的访问数量，例如池的最大连接数。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">worker</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">):</span>
    <span class="n">s</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;acquire&quot;</span><span class="p">);</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">current_process</span><span class="p">()</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;release</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
    <span class="n">s</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Semaphore</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">worker</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>


<p>结果</p>
<div class="hlcode"><pre><span></span>Process-1acquire
Process-1release

Process-2acquire
Process-3acquire
Process-2release

Process-5acquire
Process-3release

Process-4acquire
Process-5release

Process-4release
</pre></div>


<h3 id="event">Event</h3>
<p>Event用来实现进程间同步通信。</p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">wait_for_event</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;wait_for_event: starting&quot;</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;wairt_for_event: e.is_set()-&gt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">is_set</span><span class="p">()))</span>

<span class="k">def</span> <span class="nf">wait_for_event_timeout</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;wait_for_event_timeout:starting&quot;</span><span class="p">)</span>
    <span class="n">e</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;wait_for_event_timeout:e.is_set-&gt;&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">is_set</span><span class="p">()))</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
    <span class="n">w1</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;block&quot;</span><span class="p">,</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">wait_for_event</span><span class="p">,</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="p">,))</span>

    <span class="n">w2</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;non-block&quot;</span><span class="p">,</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">wait_for_event_timeout</span><span class="p">,</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">w1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">w2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">e</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;main: event is set&quot;</span><span class="p">)</span>
</pre></div>


<p>结果</p>
<div class="hlcode"><pre><span></span><span class="n">wait_for_event</span><span class="o">:</span> <span class="n">starting</span>
<span class="n">wait_for_event_timeout</span><span class="o">:</span><span class="n">starting</span>
<span class="n">wait_for_event_timeout</span><span class="o">:</span><span class="n">e</span><span class="o">.</span><span class="na">is_set</span><span class="o">-&gt;</span><span class="n">False</span>
<span class="n">main</span><span class="o">:</span> <span class="n">event</span> <span class="k">is</span> <span class="kd">set</span>
<span class="n">wairt_for_event</span><span class="o">:</span> <span class="n">e</span><span class="o">.</span><span class="na">is_set</span><span class="o">()-&gt;</span><span class="n">True</span>
</pre></div>


<h3 id="queue">Queue</h3>
<p>Queue是多进程安全的队列，可以使用Queue实现多进程之间的数据传递。put方法用以插入数据到队列中，put方法还有两个可选参数：blocked和timeout。如果blocked为True（默认值），并且timeout为正值，该方法会阻塞timeout指定的时间，直到该队列有剩余的空间。如果超时，会抛出Queue.Full异常。如果blocked为False，但该Queue已满，会立即抛出Queue.Full异常。</p>
<p>get方法可以从队列读取并且删除一个元素。同样，get方法有两个可选参数：blocked和timeout。如果blocked为True（默认值），并且timeout为正值，那么在等待时间内没有取到任何元素，会抛出Queue.Empty异常。如果blocked为False，有两种情况存在，如果Queue有一个值可用，则立即返回该值，否则，如果队列为空，则立即抛出Queue.Empty异常。Queue的一段示例代码： </p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="k">def</span> <span class="nf">writer_proc</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>      
    <span class="k">try</span><span class="p">:</span>         
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">block</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> 
    <span class="k">except</span><span class="p">:</span>         
        <span class="k">pass</span>   

<span class="k">def</span> <span class="nf">reader_proc</span><span class="p">(</span><span class="n">q</span><span class="p">):</span>      
    <span class="k">try</span><span class="p">:</span>         
        <span class="k">print</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="bp">False</span><span class="p">)</span> 
    <span class="k">except</span><span class="p">:</span>         
        <span class="k">pass</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">writer_proc</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>  
    <span class="n">writer</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>   

    <span class="n">reader</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">reader_proc</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,))</span>  
    <span class="n">reader</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>  

    <span class="n">reader</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>  
    <span class="n">writer</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>


<p>结果</p>
<div class="hlcode"><pre><span></span>1
</pre></div>


<h4 id="pipe">Pipe</h4>
<p>Pipe方法返回(conn1, conn2)代表一个管道的两个端。Pipe方法有duplex参数，如果duplex参数为True(默认值)，那么这个管道是全双工模式，也就是说conn1和conn2均可收发。duplex为False，conn1只负责接受消息，conn2只负责发送消息。</p>
<p>send和recv方法分别是发送和接受消息的方法。例如，在全双工模式下，可以调用conn1.send发送消息，conn1.recv接收消息。如果没有消息可接收，recv方法会一直阻塞。如果管道已经被关闭，那么recv方法会抛出EOFError。 </p>
<div class="hlcode"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">proc1</span><span class="p">(</span><span class="n">pipe</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">10000</span><span class="p">):</span>
            <span class="k">print</span> <span class="s2">&quot;send: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">pipe</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">proc2</span><span class="p">(</span><span class="n">pipe</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;proc2 rev:&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">proc3</span><span class="p">(</span><span class="n">pipe</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">print</span> <span class="s2">&quot;PROC3 rev:&quot;</span><span class="p">,</span> <span class="n">pipe</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">()</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">proc1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">pipe</span><span class="p">[</span><span class="mi">0</span><span class="p">],))</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">proc2</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">pipe</span><span class="p">[</span><span class="mi">1</span><span class="p">],))</span>
    <span class="c1">#p3 = multiprocessing.Process(target=proc3, args=(pipe[1],))</span>

    <span class="n">p1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="c1">#p3.start()</span>

    <span class="n">p1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">p2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="c1">#p3.join()</span>
</pre></div>


<p>结果</p>
<div class="hlcode"><pre><span></span>
</pre></div>


<h3 id="pool">Pool</h3>
<p>在利用Python进行系统管理的时候，特别是同时操作多个文件目录，或者远程控制多台主机，并行操作可以节约大量的时间。当被操作对象数目不大时，可以直接利用multiprocessing中的Process动态成生多个进程，十几个还好，但如果是上百个，上千个目标，手动的去限制进程数量却又太过繁琐，此时可以发挥进程池的功效。<br />
Pool可以提供指定数量的进程，供用户调用，当有新的请求提交到pool中时，如果池还没有满，那么就会创建一个新的进程用来执行该请求；但如果池中的进程数已经达到规定最大值，那么该请求就会等待，直到池中有进程结束，才会创建新的进程来它。</p>
<p>例：使用进程池</p>
<div class="hlcode"><pre><span></span><span class="c1">#coding: utf-8</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">print</span> <span class="s2">&quot;msg:&quot;</span><span class="p">,</span> <span class="n">msg</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;end&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;hello </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">))</span>   <span class="c1">#维持执行的进程总数为processes，当一个进程执行完毕后会添加新的进程进去</span>

    <span class="k">print</span> <span class="s2">&quot;Mark~ Mark~ Mark~~~~~~~~~~~~~~~~~~~~~~&quot;</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>   <span class="c1">#调用join之前，先调用close函数，否则会出错。执行完close后不会有新的进程加入到pool,join函数等待所有子进程结束</span>
    <span class="k">print</span> <span class="s2">&quot;Sub-process(es) done.&quot;</span>
</pre></div>


<p>一次执行结果</p>
<div class="hlcode"><pre><span></span><span class="n">mMsg</span><span class="o">:</span> <span class="n">hark</span><span class="o">~</span> <span class="n">Mark</span><span class="o">~</span> <span class="n">Mark</span><span class="o">~~~~~~~~~~~~~~~~~~~~~~</span><span class="n">ello</span> <span class="mi">0</span>

<span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">1</span>
<span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">2</span>
<span class="n">end</span>
<span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">3</span>
<span class="n">end</span>
<span class="n">end</span>
<span class="n">end</span>
<span class="n">Sub</span><span class="o">-</span><span class="n">process</span><span class="o">(</span><span class="n">es</span><span class="o">)</span> <span class="n">done</span><span class="o">.</span>
</pre></div>


<p>函数解释：</p>
<div class="hlcode"><pre><span></span>apply_async(func[, args[, kwds[, callback]]]) 它是非阻塞，apply(func[, args[, kwds]])是阻塞的（理解区别，看例1例2结果区别）
close()    关闭pool，使其不在接受新的任务。
terminate()    结束工作进程，不在处理未完成的任务。
join()    主进程阻塞，等待子进程的退出， join方法要在close或terminate之后使用。
</pre></div>


<p>执行说明：创建一个进程池pool，并设定进程的数量为3，xrange(4)会相继产生四个对象[0, 1, 2, 4]，四个对象被提交到pool中，因pool指定进程数为3，所以0、1、2会直接送到进程中执行，当其中一个执行完事后才空出一个进程处理对象3，所以会出现输出“msg: hello 3”出现在”end”后。因为为非阻塞，主函数会自己执行自个的，不搭理进程的执行，所以运行完for循环后直接输出“mMsg: hark~ Mark~ Mark~~~~~~~~~~~~~~~~~~~~~~”，主程序在pool.join（）处等待各个进程的结束。</p>
<p>例：使用进程池（阻塞）</p>
<div class="hlcode"><pre><span></span><span class="c1">#coding: utf-8</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">def</span> <span class="nf">func</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="k">print</span> <span class="s2">&quot;msg:&quot;</span><span class="p">,</span> <span class="n">msg</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">print</span> <span class="s2">&quot;end&quot;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="n">processes</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;hello </span><span class="si">%d</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">))</span>   <span class="c1">#维持执行的进程总数为processes，当一个进程执行完毕后会添加新的进程进去</span>

    <span class="k">print</span> <span class="s2">&quot;Mark~ Mark~ Mark~~~~~~~~~~~~~~~~~~~~~~&quot;</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>   <span class="c1">#调用join之前，先调用close函数，否则会出错。执行完close后不会有新的进程加入到pool,join函数等待所有子进程结束</span>
    <span class="k">print</span> <span class="s2">&quot;Sub-process(es) done.&quot;</span>
</pre></div>


<p>一次执行的结果</p>
<div class="hlcode"><pre><span></span><span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">0</span>
<span class="n">end</span>
<span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">1</span>
<span class="n">end</span>
<span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">2</span>
<span class="n">end</span>
<span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">3</span>
<span class="n">end</span>
<span class="n">Mark</span><span class="o">~</span> <span class="n">Mark</span><span class="o">~</span> <span class="n">Mark</span><span class="o">~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="n">Sub</span><span class="o">-</span><span class="n">process</span><span class="o">(</span><span class="n">es</span><span class="o">)</span> <span class="n">done</span><span class="o">.</span>
</pre></div>


<p>例：使用进程池，并关注结果</p>
<div class="hlcode"><pre><span></span><span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">0</span>
<span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">1</span>
<span class="n">msg</span><span class="o">:</span> <span class="n">hello</span> <span class="mi">2</span>
<span class="n">end</span>
<span class="n">end</span>
<span class="n">end</span>
<span class="o">:::</span> <span class="n">donehello</span> <span class="mi">0</span>
<span class="o">:::</span> <span class="n">donehello</span> <span class="mi">1</span>
<span class="o">:::</span> <span class="n">donehello</span> <span class="mi">2</span>
<span class="n">Sub</span><span class="o">-</span><span class="n">process</span><span class="o">(</span><span class="n">es</span><span class="o">)</span> <span class="n">done</span><span class="o">.</span>
</pre></div>


<p>例：使用多个进程池</p>
<div class="hlcode"><pre><span></span><span class="c1">#coding: utf-8</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">random</span>

<span class="k">def</span> <span class="nf">Lee</span><span class="p">():</span>
    <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run task Lee-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span> <span class="c1">#os.getpid()获取当前的进程的ID</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="c1">#random.random()随机生成0-1之间的小数</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span> <span class="s1">&#39;Task Lee, runs </span><span class="si">%0.2f</span><span class="s1"> seconds.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Marlon</span><span class="p">():</span>
    <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run task Marlon-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">40</span><span class="p">)</span>
    <span class="n">end</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span> <span class="s1">&#39;Task Marlon runs </span><span class="si">%0.2f</span><span class="s1"> seconds.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Allen</span><span class="p">():</span>
    <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run task Allen-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">30</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span> <span class="s1">&#39;Task Allen runs </span><span class="si">%0.2f</span><span class="s1"> seconds.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">Frank</span><span class="p">():</span>
    <span class="k">print</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Run task Frank-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">20</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">print</span> <span class="s1">&#39;Task Frank runs </span><span class="si">%0.2f</span><span class="s1"> seconds.&#39;</span> <span class="o">%</span><span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">function_list</span><span class="o">=</span>  <span class="p">[</span><span class="n">Lee</span><span class="p">,</span> <span class="n">Marlon</span><span class="p">,</span> <span class="n">Allen</span><span class="p">,</span> <span class="n">Frank</span><span class="p">]</span> 
    <span class="k">print</span> <span class="s2">&quot;parent process </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span>

    <span class="n">pool</span><span class="o">=</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">function_list</span><span class="p">:</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>     <span class="c1">#Pool执行函数，apply执行函数,当有一个进程执行完毕后，会添加一个新的进程到pool中</span>

    <span class="k">print</span> <span class="s1">&#39;Waiting for all subprocesses done...&#39;</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>    <span class="c1">#调用join之前，一定要先调用close() 函数，否则会出错, close()执行后不会有新的进程加入到pool,join函数等待素有子进程结束</span>
    <span class="k">print</span> <span class="s1">&#39;All subprocesses done.&#39;</span>
</pre></div>


<p>一次执行结果</p>
<div class="hlcode"><pre><span></span>parent process 7704

Waiting for all subprocesses done...
Run task Lee-6948

Run task Marlon-2896

Run task Allen-7304

Run task Frank-3052
Task Lee, runs 1.59 seconds.
Task Marlon runs 8.48 seconds.
Task Frank runs 15.68 seconds.
Task Allen runs 18.08 seconds.
All subprocesses done.
</pre></div>


<h2 id="_14">资料来源</h2>
<ol>
<li><a href="http://www.cnblogs.com/kaituorensheng/p/4445418.html">http://www.cnblogs.com/kaituorensheng/p/4445418.html</a></li>
<li><a href="http://python.jobbole.com/85177/">http://python.jobbole.com/85177/</a></li>
</ol>
</div>
<div id="content-footer">created in <span class="create-date date"> 2016-05-31 14:44 </span></div>
<div id="comments"></div>
<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">
<script src="https://imsun.github.io/gitment/dist/gitment.browser.js"></script>
<script type="text/javascript">
const gitment = new Gitment({
  id: location.pathname,
  title: 'Python 多线程和多进程编程总结',
  owner: 'tracholar',
  repo: 'wiki',
  oauth: {
    client_id: '0cc0476e504b5e70ae7c',
    client_secret: 'ab98e39ef79469040057eba9c6b2b543b84c72ee',
  },
  // ...
  // For more available options, check out the documentation below
})

gitment.render('comments')
// or
// gitment.render(document.getElementById('comments'))
// or
// document.body.appendChild(gitment.render())
</script>

        </div>
        <div id="footer">
            <span>
                Copyright © 2017 tracholar.
                Powered by <a href="http://simiki.org/" target="_blank">Simiki</a>.
                Fork me in <a href="https://github.com/tracholar/wiki" target="_blank"> github </a>.
            </span>
        </div>
        

        <script>
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?df74779713027375e7b79302fb72d7b0";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
        </script>


        <script src="/wiki/tipuesearch_content.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch_set.js"></script>
        <script src="/wiki/static/plugin/tipuesearch/tipuesearch.min.js"></script>
    </body>
</html>